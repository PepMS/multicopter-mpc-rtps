# MultiCopter MPC: RTPS
PX4-RTPS publisher subscriber to run MPC problems

## Environment setup

### Client: PX4 side
The function of the client is to serialize the PX4 uORB messages and to send them to the Agent.

Each message is defined in its corresponding `*.idl` file. In order to translate from uORB messages to IDL messages, PX4 firmware has an automatic translator tool that runs when PX4 firmware is built.

In order to select which messages are going to be translated to IDL a `*.yaml` file is used. The path is `Firmware/msg/tools/uorb_rtps_message_ids.yaml`. The messages with the flag `send: true` or `receive: true` will be converted to their corresponding `*.idl` file.

To build the **client side** do:
```sh
make px4_sitl_rtps
```

In case we add a flag in the `*.yaml` file do:
```sh
make px4_sitl_rtps clean
```
and compile again.

In order to launch the client side do (in case of SITL):
```
make px4_sitl_rtps gazebo
```
and in the NuttX console start the microRTPS client with a UDP connection:
```
micrortps_client start -t UDP
```

### Client: Agent side
The Agent is responsible to send the topics published by the Client to the corresponding applications (e.g. send the EKF2 output to our MPC controller). 
Also, it takes the data from the applications and sends back the data to the Client (e.g. control input from our MPC controllers to write the motor commands in the PX4).

The agent code is also automatically generated by PX4. As it has to be manually compiled and executed, it is usefull to make a symlink in a path with easy access, i.e.:
```sh
ln -s <Firmware-path>/build/px4_sitl_rtps/src/modules/micrortps_bridge/micrortps_client/micrortps_agent <desired-path>/micrortps_agent
```
and compile doing:
```sh
cd <desired-path>/micrortps_agent/build
cmake ..
make
```
The RTPS agent can be run by executing the file in the `build` folder and specifying the UDP connection:
```
./micrortps_agent -t UDP
```

### Application: Multicopter-MPC controller
We will use the fastRTPSGen tool to build a basic structure for ou publisher subscriber.
This tool uses the `*.idl` messages generated before.
As done previously, we can symlink the folder containing all the `.idl` messages:
```
ln -s <Firmware-path>/build/px4_sitl_rtps/src/modules/micrortps_bridge/micrortps_client/micrortps_agent/idl <desired-path>/idl_messages
```
Then we can already create a folder where we will run the fastRTPSGen tool. E.g.
```
mkdir pub-sub-MPC
cd pub-sub-MPC
fastrtpsgen -example x64Linux2.6gcc ../idl_messages/vehicle_odometry.idl ../idl_messages/actuator_controls.idl
```




